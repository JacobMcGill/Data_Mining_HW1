---
title: "HW1"
output:
  word_document: default
  pdf_document: default
date: "2024-01-27"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
#All relevant libraries for the assignment
library(tidyverse)
library(mosaic)
library(ggplot2)
library(rsample)
library(rsample)
library(caret)
library(modelr)
library(parallel)
library(foreach)
library(kknn)
```

#Question 1

```{r,include=FALSE}

ABIA <- read.csv("C://Users/jacob/Downloads/ABIA.csv", header = TRUE)

aus_departures = ABIA %>% filter(Origin == "AUS")
aus_departures_bycarrier = aus_departures %>% group_by(UniqueCarrier)

aus_departures_summary = aus_departures_bycarrier %>% 
  summarize(AvgDepDelay = mean(DepDelay, na.rm = TRUE)) %>%
  arrange(desc(AvgDepDelay))

aus_arrdelay_summary = aus_departures_bycarrier %>% 
  summarize(AvgArrDelay = mean(ArrDelay, na.rm = TRUE)) %>%
  arrange(desc(AvgArrDelay))

aus_cancellations = aus_departures %>% filter(Cancelled == 1)

cancellations_by_carrier = aus_cancellations %>% 
  group_by(UniqueCarrier) %>%
  summarize(NumCancellations = n())

total_flights_by_carrier = aus_departures_bycarrier %>% summarize(TotalFlights = n())
aus_cancellations = aus_departures %>% filter(Cancelled == 1)

cancellations_by_carrier = aus_cancellations %>% 
  group_by(UniqueCarrier) %>%
  summarize(NumCancellations = n())

cancellation_rate_by_carrier = merge(cancellations_by_carrier, total_flights_by_carrier, by = "UniqueCarrier")
cancellation_rate_by_carrier$CancellationRate = (cancellation_rate_by_carrier$NumCancellations / cancellation_rate_by_carrier$TotalFlights) * 100

aus_departures_with_disruption = aus_departures %>%
  mutate(SignificantDisruption = ifelse(Cancelled == 1 | ArrDelay >= 120, 1, 0))

significant_disruption_by_carrier = aus_departures_with_disruption %>%
  filter(SignificantDisruption == 1) %>%
  group_by(UniqueCarrier) %>%
  summarize(NumSignificantDisruption = n())

significant_disruption_rate_by_carrier = merge(significant_disruption_by_carrier, total_flights_by_carrier, by = "UniqueCarrier")
significant_disruption_rate_by_carrier$SignificantDisruptionRate = 
  (significant_disruption_rate_by_carrier$NumSignificantDisruption / significant_disruption_rate_by_carrier$TotalFlights) * 100
```

## 1) Data Visualization: Flights at ABIA

```{r, echo=FALSE}

ggplot(aus_arrdelay_summary, aes(x = reorder(UniqueCarrier, -AvgArrDelay), y = AvgArrDelay)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  labs(title = "Average Arrival Delay by Carrier (AUS Departures)",
       x = "Carrier",
       y = "Average Arrival Delay (minutes)")

ggplot(cancellation_rate_by_carrier, aes(x = reorder(UniqueCarrier, -CancellationRate), y = CancellationRate)) +
  geom_bar(stat = "identity", fill = "coral") +
  labs(title = "Cancellation Rate by Carrier (AUS Departures)",
       x = "Carrier",
       y = "Cancellation Rate (%)")



```
#Focusing on departures out of Austin, these figures provide insights into arrival delays and cancellation rate by airline. I chose to focus on arrival delays specifically because I consider this the superior measure of passenger experience, given that departure delays can often be made up for (at least in part) in the air.

```{r, echo=FALSE}

ggplot(significant_disruption_rate_by_carrier, aes(x = reorder(UniqueCarrier, -SignificantDisruptionRate), y = SignificantDisruptionRate)) +
  geom_bar(stat = "identity", fill = "purple") +
  labs(title = "Significant Disruption Rate by Carrier (AUS Departures)",
       x = "Carrier",
       y = "Significant Disruption Rate (%)")

```

#After defining a new variable for a "Signficant Disruption" that represents a flight that is either cancelled or delayed by 2+ hours, this visualization shows the Significant Disruption Rate by carrier for flights out of AUS. 



#Question 2

## 2A) 95th Percentile of Heights for Female Athletics Competitors 

```{r, echo=FALSE}
olympics <- read.csv('C://Users/jacob/Downloads/olympics_top20.csv', header=TRUE)
olympics_athletics = olympics %>% filter(sport=="Athletics", sex=="F")
athletics_q95_height <- quantile(olympics_athletics$height, 0.95, na.rm = TRUE)
cat("The 95th percentile of heights for female competitors in Athletics events is:", athletics_q95_height, "centimeters\n")
```

## 2B) Women's events with the greatest variability in competitor's heights across the entire history of the Olympics, as measured by the standard deviation?

```{r 3B, message=FALSE, echo=FALSE}

greateset_variability = olympics %>%
  filter(sex=="F") %>%
  group_by(event) %>%
  summarize(sd_height = sd(height))%>%
  arrange(desc(sd_height))

head(greateset_variability,1)


```



## 2C) Average Age of Olympic Swimmers Over Time

```{r, echo=FALSE}
olympics_swimming = olympics %>% filter(sport=="Swimming")
average_age_swimming <- olympics_swimming %>% group_by(year, sex) %>% summarize(AvgAge = mean(age, na.rm = TRUE))
ggplot(average_age_swimming, aes(x = year, y = AvgAge, color = sex)) +
  geom_line() +
  labs(title = "Average Age of Olympic Swimmers Over Time",
       x = "Year",
       y = "Average Age")
       
cat("The plot illustrates how the average age of Olympic swimmers has changed over time, stratified by gender.")
```

# Question 3
```{r, include=FALSE}
sclass = read.csv('C://Users/jacob/Downloads/sclass.csv', header=TRUE)

#Filter data into 350 and 63 AMG sets
three_fiftys = sclass %>%
  filter(trim == "350")
AMG = sclass %>%
  filter(trim == "63 AMG")
#Create training and test splits for both
three_fifty_split = initial_split(three_fiftys, prop=0.8)
three_fifty_train = training(three_fifty_split)
three_fifty_test = testing(three_fifty_split)
K_folds = 10
threefifty_folds = crossv_kfold(three_fiftys, k=K_folds)
k_grid = c(2, 3, 4, 5, 6, 7, 8,9,10, 11, 12, 15, 16, 17, 18, 20, 22, 25, 27, 30, 32, 35, 37, 40, 45,
           50, 60, 70, 80, 90, 100, 125, 150, 175, 200, 250, 300)
cv_grid = foreach(k = k_grid, .combine='rbind') %dopar% {
  models = map(threefifty_folds$train, ~ knnreg(price ~ mileage, k=k, data = ., use.all=FALSE))
  errs = map2_dbl(models, threefifty_folds$test, modelr::rmse)
  c(k=k, err = mean(errs), std_err = sd(errs)/sqrt(K_folds))
} %>% as.data.frame
```

```{r, include = TRUE}
ggplot(cv_grid) + 
  geom_line(aes(x=k, y=err)) + 
  geom_errorbar(aes(x=k, ymin = err-std_err, ymax = err+std_err)) + 
  scale_x_log10()
```
```{r, include=TRUE, error = FALSE}
opt_err = cv_grid[which.min(cv_grid$err), ]
opt_k = opt_err[1,1]
opt_k
```
```{r, include = FALSE}
three_fifty_knn_opt = knnreg(price ~ mileage, k=opt_k, data = three_fiftys)
three_fiftys = three_fiftys %>% 
  mutate(three_fifty_pred = predict(three_fifty_knn_opt, three_fiftys))
mileage_plot = ggplot(data = three_fiftys) +
  geom_point(aes(x=mileage, y = price), alpha = 0.2)
```

```{r, include = TRUE}
#mileage_plot = ggplot(data = three_fiftys) +
 # geom_point(aes(x=mileage, y = price), alpha = 0.2) 
  #ylim(7000, 20000) 
 # geom_line(x = mileage, y =three_fifty_predict,, color='red', size=1.5 )
mileage_plot + geom_line(aes(x = mileage, y = three_fifty_pred), color='red', size=1.5)

```

```{r, include = FALSE}
#Create training and test splits for both
AMG_K_folds = 10
AMG_folds = crossv_kfold(AMG, k=AMG_K_folds)
AMG_k_grid = c(2, 3, 4, 6, 8, 10, 15, 20, 25, 30, 35, 40, 45,
           50, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 70, 75, 80, 85, 90, 100, 125, 150, 175, 200, 250, 300)
AMG_cv_grid = foreach(k = k_grid, .combine='rbind') %dopar% {
  models = map(AMG_folds$train, ~ knnreg(price ~ mileage, k=k, data = ., use.all=FALSE))
  errs = map2_dbl(models, AMG_folds$test, modelr::rmse)
  c(k=k, err = mean(errs), std_err = sd(errs)/sqrt(K_folds))
} %>% as.data.frame
```

```{r, include = TRUE}
ggplot(AMG_cv_grid) + 
  geom_line(aes(x=k, y=err)) + 
  geom_errorbar(aes(x=k, ymin = err-std_err, ymax = err+std_err)) + 
  scale_x_log10()
```

```{r, include=TRUE}
AMG_opt_err = AMG_cv_grid[which.min(AMG_cv_grid$err), ]
AMG_opt_k = AMG_opt_err[1,1]
AMG_opt_k
```

```{r, include = FALSE}
AMG_knn_opt = knnreg(price ~ mileage, k=AMG_opt_k, data = AMG)
AMG = AMG %>% 
  mutate(AMG_pred = predict(AMG_knn_opt, AMG))
AMG_mileage_plot = ggplot(data = AMG) +
  geom_point(aes(x=mileage, y = price), alpha = 0.2)
```

```{r, include = TRUE}

AMG_mileage_plot + geom_line(aes(x = mileage, y = AMG_pred), color='red', size=1.5)

```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
